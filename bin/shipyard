#!/usr/bin/env node
var program = require('commander'),
    path = require('path'),
    env = require('../lib/shipyard/env'),
    log = require('../lib/shipyard/utils/log'),
    shipyard = require('../'),
    builder = require('../scripts/build'),
    server = require('../scripts/server'),
    shell = require('../scripts/shell').shell,
    test = require('../scripts/test');

var dir = process.cwd();

function pushShipyard() {
    if (env.platform.version > '0.4.x') {
        log.debug('Shipyard not pushed onto path. Must be in node_modules folder to work well.');
    } else {
        var lib = path.join(shipyard.dirname, shipyard.directories.lib);
        var testigo = path.join(shipyard.dirname, './test/');

        //TODO: this doesn't work in Node 0.5+
        require.paths.unshift(testigo);
        require.paths.unshift(lib);
    }
}

program
    .version(shipyard.version)
    .option('-d, --dir <dir>', 'choose different directory', function(d) {
        dir = path.join(dir, d);
    })
    .option('-r, --require', 'include mini require')
    .option('-m, --minify', 'force a minify')
    .option('-M, --non-minify', 'do not minify');

program
    .command('build [dest]')
    .description('Compress app into a single file')
    .action(function(dest) {
        builder.compile(dir, dest, {
            force_minify: this.minify,
            no_minify: this.nonMinify,
            mini_require: this.require
        });
    });

program
    .command('test')
    .description('Run your app\'s test suite')
    .action(function() {
        var pack = shipyard.loadPackage(dir);
        var tests = path.join(dir, pack.shipyard.test);

        pushShipyard();

        var cases = test.load(tests, program.args);
        test.run(cases);
    });

program
    .command('server')
    .description('Run a simple server')
    .action(function() {
        server.serve(dir);
    });

program
    .command('new <name>')
    .description('Generate a new app')
    .action(function(name) {
        log.warn('not implemented yet');
        log.debug('generating %s', name);
    });

program
    .command('shell')
    .description('A node shell with Shipyard already on the path')
    .action(function() {
        pushShipyard();
        shell();
    });

program.parse(process.argv);
if (process.argv.length == 2) {
    program.emit('help');
}
